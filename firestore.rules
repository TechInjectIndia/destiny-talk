rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is accessing their own data
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // --- USERS ---
    match /users/{userId} {
      // DEV NOTE: 'list' allowed for Admin Dashboard demo
      allow read: if isAuthenticated(); 
      allow write: if isOwner(userId);
    }

    // --- REPORTS ---
    match /reports/{reportId} {
      // Allow read if document doesn't exist (for initial reads) or user owns it
      allow read: if !exists(/databases/$(database)/documents/reports/$(reportId)) || 
                     (resource != null && resource.data.userId == request.auth.uid) || 
                     isAuthenticated(); // Allow admin read
      allow write: if isAuthenticated() && request.resource.data.userId == request.auth.uid; 
    }

    // --- WALLET ---
    // DEV NOTE: 'write' allowed for MVP demo. In Prod, set to 'false' (Admin only).
    match /wallet/{userId} {
      allow read: if isOwner(userId) || isAuthenticated(); // Allow admin read
      allow write: if isOwner(userId); 
    }

    // --- WALLET TRANSACTIONS ---
    // DEV NOTE: 'write' allowed for MVP demo. In Prod, set to 'false' (Admin only).
    match /walletTransactions/{txId} {
      allow read: if !exists(/databases/$(database)/documents/walletTransactions/$(txId)) ||
                     (resource != null && resource.data.walletId == request.auth.uid) ||
                     isAuthenticated(); // Allow admin read
      allow write: if isAuthenticated() && request.resource.data.walletId == request.auth.uid;
    }

    // --- CHATS ---
    match /chats/{chatId} {
      allow read: if !exists(/databases/$(database)/documents/chats/$(chatId)) ||
                     (resource != null && resource.data.userId == request.auth.uid) ||
                     isAuthenticated();
      allow write: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }

    // --- CHAT MESSAGES ---
    match /chatMessages/{messageId} {
      // DEV NOTE: Relaxed for MVP to allow client to save AI responses.
      allow read, write: if isAuthenticated();
    }

    // --- PROMPTS (New for Phase 2) ---
    match /prompts/{promptId} {
      // DEV NOTE: Open for demo admin
      allow read, write: if isAuthenticated();
    }

    // --- ORDERS ---
    match /orders/{orderId} {
      // Allow read if document doesn't exist, user owns it, or authenticated (for admin)
      allow read: if !exists(/databases/$(database)/documents/orders/$(orderId)) ||
                     (resource != null && resource.data.userId == request.auth.uid) ||
                     isAuthenticated(); // Allow admin read
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Allow update if user owns it or authenticated (for admin)
      allow update: if isAuthenticated() && (
                      (resource != null && resource.data.userId == request.auth.uid) ||
                      true // Allow admin update
                    );
    }

    // --- ANALYTICS ---
    match /analytics/{eventId} {
      // Allow authenticated users to log events and read their own events
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }
  }
}